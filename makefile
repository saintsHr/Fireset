# ====================================================
# Project
# ====================================================
TARGET := fireset

# ====================================================
# Tools
# ====================================================
CC := gcc
AR := ar
RM := rm -rf

# ====================================================
# Sources
# ====================================================
SRC := $(shell find src -name "*.c")

# ====================================================
# Build dirs (default = debug)
# ====================================================
BUILD_DIR := build/debug

# ====================================================
# Objects
# ====================================================
OBJ := $(patsubst src/%.c,$(BUILD_DIR)/%.o,$(SRC))
DEP := $(OBJ:.o=.d)

# ====================================================
# Flags
# ====================================================
DEPFLAGS := -MMD -MP

CFLAGS := -g -O0 -Wall -Wextra -Iinclude $(DEPFLAGS)
LDFLAGS :=

# ====================================================
# Outputs (same names)
# ====================================================
BIN := bin/$(TARGET)
LIB := lib/lib$(TARGET).a

# ====================================================
# Phony
# ====================================================
.PHONY: all debug release clean

# ====================================================
# High-level targets
# ====================================================
all: debug

debug: $(BIN) $(LIB)

release: BUILD_DIR := build/release
release: CFLAGS := -O3 -Wall -Wextra -Iinclude $(DEPFLAGS)
release: $(BIN) $(LIB)

# ====================================================
# Executable
# ====================================================
$(BIN): $(OBJ)
	@mkdir -p bin
	$(CC) $(CFLAGS) $^ -o $@ $(LDFLAGS)

# ====================================================
# Static library
# ====================================================
$(LIB): $(OBJ)
	@mkdir -p lib
	$(AR) rcs $@ $^

# ====================================================
# Object compilation
# ====================================================
$(BUILD_DIR)/%.o: src/%.c
	@mkdir -p $(dir $@)
	$(CC) $(CFLAGS) -c $< -o $@

# ====================================================
# Dependencies
# ====================================================
-include $(DEP)

# ====================================================
# Cleaning
# ====================================================
clean:
	$(RM) build bin lib